{"result": {"folders": ["lab1"], "nr": 1449, "data": {"embed_links": []}, "created": "2020-04-11T17:57:13Z", "bucket_order": 3, "no_answer_followup": 0, "change_log": [{"anon": "no", "uid": "k8mkxrs7jjp35j", "data": "k8vx8vdlogw2sf", "v": "all", "type": "create", "when": "2020-04-11T17:57:13Z"}, {"anon": "no", "uid": "jw772s2fp4hU", "data": "k8y26zrotov4rq", "to": "k8vx8vdin5g2se", "type": "s_answer", "when": "2020-04-13T05:51:16Z"}, {"anon": "no", "uid": "jw772s2fp4hU", "data": "k8y3x3a0qb599", "type": "s_answer_update", "when": "2020-04-13T06:39:33Z"}, {"anon": "no", "uid": "jw772s2fp4hU", "data": "k8y4338tb714hp", "type": "s_answer_update", "when": "2020-04-13T06:44:13Z"}, {"anon": "no", "uid": "jw772s2fp4hU", "data": "k8y43jnlwno4sf", "type": "s_answer_update", "when": "2020-04-13T06:44:34Z"}, {"anon": "no", "uid": "jw772s2fp4hU", "data": "k8y4xt80e1b1fe", "type": "s_answer_update", "when": "2020-04-13T07:08:06Z"}, {"anon": "no", "uid": "jw772s2fp4hU", "data": "k8y4yice3mx1wd", "type": "s_answer_update", "when": "2020-04-13T07:08:39Z"}], "bucket_name": "Today", "history": [{"anon": "no", "uid": "k8mkxrs7jjp35j", "subject": "请教一个lab1扩展练习遇到的问题", "created": "2020-04-11T17:57:13Z", "content": "<p>大家好&#xff0c;</p>\n<p>在做扩展练习的时候有一个地方我想不明白。</p>\n<p>在T_SWITCH_TOU中&#xff0c;我的理解是在进入中断服务后&#xff0c;建立一个局部变量&#xff0c;保存*tf里边的值&#xff0c;然后依次改变段寄存器CS&#xff0c;DS&#xff0c;ES&#xff0c;SS的值&#xff0c;使得段选择子指向用户态&#xff0c;以此来实现内核到用户态的转换。之后将保存参数的地址进行修改&#xff0c;就是下面这段代码。</p>\n<pre>  *((uint32_t *)tf - 1) = (uint32_t)&amp;switchk2u;</pre>\n<p>这样trap函数返回后&#xff0c;pop esp使得esp寄存器里保存的是switchk2u的地址。然后开始iret。</p>\n<p>到这里我认为我的理解都还没有问题。但是&#xff0c;T_SWITCH_TOU 这个中断服务是系统处于内核态的时候发起的&#xff0c;T_SWITCH_TOU的DPL是0&#xff0c;也就是说进入这个例程的时候&#xff0c;CPU没有检测到特权级的改变。所以ss和esp也就不会被压进栈。那么这个时候&#xff0c;为什么还要对switchk2u.tf_esp进行改变&#xff1f;</p>\n<p>还句话说就是&#xff0c;以下这段代码有什么作用&#xff0c;我注释掉这段代码&#xff0c;好像也并不影响结果&#xff1f;</p>\n<p>而且这个时候IRET难道会pop出来ss和esp吗&#xff1f;</p>\n<p>烦请大家帮忙解答一下&#xff0c;万分感谢&#xff01;</p>\n<p></p>\n<pre>  switchk2u.tf_esp = (uint32_t)tf &#43; sizeof(struct trapframe) - 8;</pre>\n<p></p>"}], "type": "question", "tags": ["lab1", "student"], "tag_good": [], "unique_views": 124, "children": [{"folders": [], "data": {"embed_links": []}, "children": [], "created": "2020-04-13T05:51:16Z", "bucket_order": 3, "tag_endorse": [{"role": "student", "name": "Guoqiang Zhong", "endorser": {}, "admin": false, "photo": null, "id": "k8mkxrs7jjp35j", "photo_url": null, "published": true, "us": false, "facebook_id": null}], "bucket_name": "Today", "id": "k8y26zrjz8u4rp", "history": [{"anon": "no", "uid": "jw772s2fp4hU", "subject": "", "created": "2020-04-13T07:08:39Z", "content": "<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">As with a real-address mode interrupt return, the IRET instruction pops the return instruction pointer, return code segment selector, and EFLAGS image from the stack to the EIP, CS, and EFLAGS registers, respectively, and then<br />resumes execution of the interrupted program or procedure. If the return is to another privilege level, the IRET instruction also pops the stack pointer and SS from the stack, before resuming program execution. If the return is to virtual-8086 mode, the processor also pops the data segment registers from the stack.</span></span></p>\n<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">IRET在返回时的特权级改变的时候&#xff0c;是会按照顺序弹出EIP&#xff0c;CS&#xff0c;PWS&#xff0c;ESP&#xff0c;SS的。</span></span></p>\n<p></p>\n<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">不过lab1这里其实感觉压根就不会弹出SS和ESP……因为lab1直接切换测试这里把所有的段寄存器权限都设置成了ring 3&#xff0c;所以特权级对于处理器相当于没变过……</span></span></p>"}, {"anon": "no", "uid": "jw772s2fp4hU", "subject": "", "created": "2020-04-13T07:08:06Z", "content": "<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">As with a real-address mode interrupt return, the IRET instruction pops the return instruction pointer, return code segment selector, and EFLAGS image from the stack to the EIP, CS, and EFLAGS registers, respectively, and then<br />resumes execution of the interrupted program or procedure. If the return is to another privilege level, the IRET instruction also pops the stack pointer and SS from the stack, before resuming program execution. If the return is to virtual-8086 mode, the processor also pops the data segment registers from the stack.</span></span></p>\n<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">IRET在返回时的特权级改变的时候&#xff0c;是会按照顺序弹出EIP&#xff0c;CS&#xff0c;PWS&#xff0c;ESP&#xff0c;SS的。</span></span></p>\n<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\"></span></span></p>\n<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">不过lab1这里其实感觉压根就不会弹出SS和ESP……因为lab1直接切换测试这里把所有的段寄存器权限都设置成了ring 3……</span></span></p>"}, {"anon": "no", "uid": "jw772s2fp4hU", "subject": "", "created": "2020-04-13T06:44:34Z", "content": "<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">IRET在特权级改变的时候&#xff0c;是会按照顺序弹出EIP&#xff0c;CS&#xff0c;PWS&#xff0c;ESP&#xff0c;SS的。所以需要设置switchk2u.tf_esp和switchk2u.tf_ss。</span></span></p>"}, {"anon": "no", "uid": "jw772s2fp4hU", "subject": "", "created": "2020-04-13T06:44:13Z", "content": "<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">IRET在特权级改变的时候&#xff0c;是会按照顺序投放EIP&#xff0c;CS&#xff0c;PWS&#xff0c;ESP&#xff0c;SS的。所以需要设置switchk2u.tf_esp和switchk2u.tf_ss。</span></span></p>"}, {"anon": "no", "uid": "jw772s2fp4hU", "subject": "", "created": "2020-04-13T06:39:33Z", "content": "<p><span style=\"vertical-align:inherit\"><span style=\"vertical-align:inherit\">IRET在特权级改变的时候&#xff0c;是会按照顺序投放EIP&#xff0c;CS&#xff0c;PWS&#xff0c;ESP&#xff0c;SS的。</span></span></p>"}, {"anon": "no", "uid": "jw772s2fp4hU", "subject": "", "created": "2020-04-13T05:51:16Z", "content": "<p>IRET在特权级改变的时候&#xff0c;是会按照顺序弹出EIP、CS、PWS、ESP、SS的。</p>\n<pre> *((u32 *)tf - 1) = (u32)&amp;switchk2u;</pre>\n<p>CPU没有检测到特权级的改变&#xff0c;所以ss和esp也就<strong>不会</strong>被压进栈没错&#xff0c;所以这行代码就是将新的tf放入<strong>旧的tf esp</strong>那个位置&#xff0c;之后弹出的时候&#xff0c;即iret的时候&#xff0c;会弹出临时新构造的switchk2u中的EIP、CS、PWS、ESP、SS。</p>"}], "type": "s_answer", "tag_endorse_arr": ["k8mkxrs7jjp35j"], "config": {}, "is_tag_endorse": false}], "tag_good_arr": [], "no_answer": 0, "id": "k8vx8vdin5g2se", "config": {"seen": {"33": 4, "709": 9, "122": 1, "1359": 2, "134": 0, "1445": 6, "554": 7, "616": 5, "51": 3, "1370": 8}}, "status": "active", "drafts": null, "request_instructor": 0, "request_instructor_me": false, "bookmarked": 3, "num_favorites": 0, "my_favorite": false, "is_bookmarked": false, "is_tag_good": false, "q_edits": [], "i_edits": [], "s_edits": [], "t": 1643170073698, "default_anonymity": "no"}, "error": null, "aid": "kyv11baaetx6mf"}